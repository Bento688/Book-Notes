<%- include("partials/header.ejs") %>

<section class="admin-page">
  <div class="form-box">
    <div class="form-container">
      <div class="back-button-container">
        <a href="/" class="back-button">&larr; Back to Home</a>
      </div>
      <h2>Create</h2>
      <form action="/admin/create" class="create-form" method="post">
        <label for="bookname">Insert Book Name</label>
        <input type="text" id="bookname" name="bookname" />
        <label for="isbn">Insert Book ISBN</label>
        <input type="text" name="isbn" id="isbn" />
        <p>
          https://covers.openlibrary.org/b/isbn/***INSERT ISBN
          HERE***-M.jpg?default=false
        </p>
        <label for="desc">Insert Book Description</label>
        <input type="text" id="desc" name="desc" />
        <label for="author">Insert Author</label>
        <input type="text" id="author" name="authorName" />
        <label for="rating">Insert Book Rating</label>
        <input
          type="number"
          id="rating"
          name="rating"
          min="0"
          max="10"
          step="0.1"
        />
        <button type="submit">Create</button>
      </form>
    </div>
    <img
      id="cover-preview"
      src=""
      alt="Book not found"
      style="max-width: 150px; margin-top: 10px; display: none"
    />
  </div>

  <div class="books-list">
    <% if(locals.books) {%>
    <h2>Manage Books</h2>
    <ul>
      <% books.forEach(book => { %>
      <div class="admin-books">
        <img
          src="https://covers.openlibrary.org/b/isbn/<%= book.isbn %>-M.jpg"
          alt="<%= book.title %>"
        />
        <div class="admin-books-flex-1">
          <strong><%= book.title %></strong>
          <div class="admin-books-flex-2">
            <!-- Edit button now opens modal instead of submitting form -->
            <button
              class="dark-brown-button"
              type="button"
              onclick="openEditForm('<%= book.id %>', '<%= book.title %>', '<%= book.isbn %>', '<%= book.description %>', '<%= book.personal_rating %>', '<%= book.author_name %>')"
            >
              Edit
            </button>
            <form
              action="/admin/delete/<%= book.id %>"
              method="post"
              style="display: inline"
            >
              <input type="hidden" name="id" value="<%= book.id %>" />
              <button class="dark-brown-button" type="submit">Delete</button>
            </form>
            <a
              class="dark-brown-button"
              href="/admin/books/<%= book.id %>/notes"
              >View Notes</a
            >
          </div>
        </div>
      </div>
      <% }) %>
    </ul>
    <% } %>
  </div>

  <!-- Modal Edit Form (hidden by default) -->
  <div id="edit-overlay" class="overlay hidden">
    <div class="modal">
      <h2>Edit Book</h2>
      <form action="/admin/update" method="post">
        <input type="hidden" id="edit-id" name="id" />

        <label for="edit-title">Title</label>
        <input type="text" id="edit-title" name="title" required />

        <label for="edit-isbn">ISBN</label>
        <input type="text" id="edit-isbn" name="isbn" required />

        <label for="edit-desc">Desc</label>
        <input type="text" id="edit-desc" name="desc" required />

        <label for="edit-rating">Rating</label>
        <input type="text" id="edit-rating" name="rating" required />

        <label for="edit-author">Author</label>
        <input type="text" id="edit-author" name="authorName" required />

        <button type="submit">Save</button>
        <button type="button" onclick="closeEditForm()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    function openEditForm(id, title, isbn, desc, rating, author) {
      document.getElementById("edit-overlay").classList.remove("hidden");
      document.getElementById("edit-id").value = id;
      document.getElementById("edit-title").value = title;
      document.getElementById("edit-isbn").value = isbn;
      document.getElementById("edit-desc").value = desc;
      document.getElementById("edit-rating").value = rating;
      document.getElementById("edit-author").value = author;
    }

    function closeEditForm() {
      document.getElementById("edit-overlay").classList.add("hidden");
    }

    const isbnInput = document.getElementById("isbn");
    const coverPreview = document.getElementById("cover-preview");

    isbnInput.addEventListener("input", () => {
      const isbn = isbnInput.value.trim();
      if (isbn) {
        coverPreview.src = `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg?default=false`;
        coverPreview.style.display = "block";
      } else {
        coverPreview.style.display = "none";
      }
    });
  </script>
</section>

<%- include("partials/footer.ejs") %>
